
# Limitations

* Strings and arrays are not supported
* Must use ROS_PRG configuration with all the variables inside
* Must not change the node name as the update script searches for a '.../robin' node
* Must have bash (devel/setup.bash)
* Must restart codesyscontrol service
* Each robin object can only be used in one POU

* Strings and arrays with fixed size only (STRING[] defaults to 80 in CODESYS)


# Setup

1. Clone the repository into your catkin workspace:
  ```sh
  cd ~/catkin_ws
  git clone https://github.com/ScalABLE40/robin
  ```

* To avoid having to manually restart codesyscontrol after each update run:
  ```sh
  echo "$USER ALL=(ALL:ALL) NOPASSWD: /bin/systemctl restart codesyscontrol" |
  sudo EDITOR="tee" visudo -f /etc/sudoers.d/allow_restart_codesyscontrol
  ```
  This will allow the command `systemctl restart codesyscontrol` to be run with sudo without having to enter your password. This requires that the user belongs to the 'sudo' group.


# Usage

## Data types map

CODESYS                 | C++                    | ROS                    | ROS msg
------------------------|------------------------|------------------------|------------------------
BYTE                    | uint8_t                | byte                   | std_msgs::Byte
INT                     | int16_t                | int16                  | std_msgs::Int16
ARRAY[min..max] OF \*   | \*[max - min + 1]      | \*[max - min + 1]      | std_msgs::\*MultiArray

* If you want to pass a single fixed length array without using _std_msgs::\*MultiArray_, create a CODESYS structure DUT containing a single array. You can name it whatever you want. For an array of 10 doubles, for example, that could be:
```
TYPE Float64Array :
STRUCT
  data : ARRAY[1..10] OF LREAL;
END_STRUCT
END_TYPE
```


# TODOs

* WIP manually implement fixed size array base type
* update.py support fixed size array base type

* manually implement variable size array base type
* update.py support variable size array base type

* fix: shm_size_, msg_size_ approach won't work recursively; use local variables

* support strings and arrays
  * update.py: update to handle strings/arrays
    * update template constants
    * support codesys array base type
    * support struct with strings
    * support struct with arrays
    * ...
  * update.py: add isPOD() method; only specialize template if struct is not POD
  * function to simplify array/vector copy

* support variables from different POUs or from GVLs
  * check xml for external variable
* check all combinations (no msgs, ros msgs, custom msgs, X both ros and custom msgs)
* review isOpen logic
* ros: pass node nodehandle to robin objects
* unit tests
    * sem/shm read/write list of values
* integ tests
* different error codes
* readme
* compare performance with old version
* compare performance of using ROS fixed size array or ROS MultiArray
* optimize performance
    * reduce isOpen checks if performance worse than old version
    * reduce ifs, loops
    * time tests
    * ? replace std::string with char*
    * pass by ref or val?
    * is read thread faster than old way? (specially in beagle; can it handle it?)
* update.py: move template constants to file
* update.py: improve code

## Later
* support multiple nodes named robin in different namespaces
* include robin.h only (contains robin_publisher, robin_subscriber, etc.)
* scan network before updating
    * get project children (device), get gateway, get targets, sel target, set comm path
    * OR get gateways, sel gateway, get targets, sel targets, set comm path
* start_update.py: export specified project instead of primary
    * if no arg and no primary, error
* option to publish on change only (eg '{attrib...')
* option to zero values if not updated after some time
* option to zero or keep unsent values in variable length arrays
* option to choose publishing/reading rates
* support robin objects defined in other POUs or from GVLs
* update.py: update source files only if changed
* update.py: check if source updates were successful
* support ros services
* support ros actions
* update README.md variable mapping table from types.yml

## Maybe
* encapsulate everything in class(es): RobinUpdateStarter, RobinUpdater
* detect shell used to compile
* start_update.py: config.yml for ssh settings
* ros side as service as well
* single shm space
* change header files to .hpp extension
* change inst.cpp to impl.cpp
* use c++ macros to automate struct member assignments based on structs.h
* group RobinPublishers with same rate into single threads
* pass DEF_ARRAY_SIZE to robin fb
* update.py: print 'Updating...' and pause inside


# Code

## robin_node.cpp
```c++
  // enable rosconsole logging
  if (ros::console::set_logger_level(ROSCONSOLE_DEFAULT_NAME, ros::console::levels::Debug))
  {
   ros::console::notifyLoggerLevelsChanged();
  }
```

## structs.h
```c++
#include <cstdint>  // for uint8_t, etc.

// avoid structure padding; not standard
#pragma pack(1) -->
```

## start_update.py
```python
# scan network
gw = online.gateways['Gateway-1']
gw.perform_network_scan()
try:
    online.gateways['Gateway-1'].perform_network_scan()
except:
    system.ui.error('Update failed.')
    raise SystemExit
devices = projects.primary.find('Device', recursive=False)
if devices is None or len(devices) != 1:
    system.ui.error('Failed to find device.')
    raise SystemExit
guid = devices[0].get_gateway()
online.gateways[guid].perform_network_scan()
```

## update.py
```python
# add codesyscontrol restart command to sudoers.d
cmd = '''sudo -n systemctl restart codesyscontrol 2> /dev/null ||
         ls /etc/sudoers.d/allow_restart_codesyscontrol > /dev/null 2>&1 ||
         echo "$USER ALL=(ALL:ALL) NOPASSWD: $(which systemctl) restart codesyscontrol" |
         sudo EDITOR="tee" visudo -f /etc/sudoers.d/allow_restart_codesyscontrol > /dev/null &&
         sudo -n systemctl restart codesyscontrol'''
```

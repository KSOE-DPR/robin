
# Limitations

* Strings and arrays are not supported
* Must use ROS_PRG configuration with all the variables inside
* Must not change the node name as the update script searches for a '.../robin' node
* Must have bash (devel/setup.bash)
* Must restart codesyscontrol service
* Each robin object can only be used in one POU
* Random CODESYS error (possibly due to ANY variable)

* Strings and arrays with fixed size only (STRING[] defaults to 80 in CODESYS)


# Usage

* Example CODESYS program
  ```
  PROGRAM ROS_PRG
  VAR_INPUT
    double_to_ros : LREAL;
  END_VAR
  VAR
    robin: Robin;
  END_VAR
  robin();
  robin.write('double_var', double_to_ros);
  ```

## Data types map

CODESYS                 | C++                    | ROS                    | ROS msg
------------------------|------------------------|------------------------|------------------------
ROS_BYTE                | uint8_t                | byte                   | std_msgs::Byte
INT                     | int16_t                | int16                  | std_msgs::Int16
ARRAY[min..max] OF \*   | \*[max - min + 1]      | \*[max - min + 1]      | std_msgs::\*MultiArray

<!-- * If you want to pass a single fixed length array without using _std_msgs::\*MultiArray_, create a CODESYS structure DUT containing a single array. You can name it whatever you want. For an array of 10 doubles, for example, that could be:
```
TYPE Float64Array :
STRUCT
  data : ARRAY[1..10] OF LREAL;
END_STRUCT
END_TYPE
``` -->


# TODO

* release
  * readme
    * go through installation
  * upload .library and example.xml
  * restructure project

* WIP
  * review ROS/CODESYS primitive types
    * types.yml add primitive.derived
    * support primitive.derived
    * support '{attribute 'suffixed'}' for structs and struct members
    * improve "if member.msg_pkg != 'robin' and member.type == 'derived':" ('member.type' not enough; eg ros time type will be a struct (derived) in codesys)
    * test
      * ros time and duration primitives not defined in types.yml
  * debug string arrays
  * test all types

* updater: test support array of struct with strings/arrays
* add remaining msg packages
* debug
  * check all combinations (no msgs, ros msgs, custom msgs, X both ros and custom msgs)
  * etc.
  * test in robots
* get Robin.DEF_ARRAY_LEN from xml
* support variables from different POUs or from GVLs
  * check xml for external variable
  * fix name collisions
  * consider namespaces
* fix need to restart codesyscontrol even when structure is unchanged
  * try without ANY (still use methods)
* add remaining ros msg packages to codesys project and types.yml
* document classes, methods, etc. (@param, @return, etc.)
* unit tests
    * sem/shm read/write list of values
* integration tests
* simplify robin_inst.cpp: eg function to simplify array/vector copy
* compare performance with old version
* optimize performance
    * reduce isOpen checks if performance worse than old version
    * reduce ifs, loops
    * time tests
    * ? replace std::string with char*
    * pass by ref or val?
    * is read thread faster than old way? (specially in beagle; can it handle it?)
* vlarrays: pass array length and read only length elements
  * quick performance estimation?
  * implement
  * compare performance
* updater: support multidimensional arrays
* extend msg objects to point to shm directly
* detalhar TODOs
* review c++ 'structure padding': see [Code section](#code)

## Later
* license badge
* review isOpen logic
* different error codes
* support include Robin from other package
* restart codesys if ros node dies
* update.py: update source files only if changed (eg create tmp file; if different: rename; else: delete tmp)
* prettify robin_insts.cpp: create intermediate constant variables to avoid long namespaces
* check robin name is valid (no invalid characters)
* prepend shm names with 'robin_' to avoid name collisions with other programs
  * even better, use a single shm space
* types.yml: codesys->iec/base, ros->ros_msg_pkgs/msgs_pkgs/msgs
* gen_demo_project.py codesys demo project generator
* support multiple nodes named robin in different namespaces
* include robin.h only (contains robin_publisher, robin_subscriber, etc.)
* scan network before updating
    * get project children (device), get gateway, get targets, sel target, set comm path
    * OR get gateways, sel gateway, get targets, sel targets, set comm path
* start_update.py: export specified project instead of primary
    * if no arg and no primary, error
* option to publish on change only (eg '{attrib...')
* option to zero values if not updated after some time
* option to zero or keep unsent values in variable length arrays
* option to choose publishing/reading rates
* support robin objects defined in other POUs or from GVLs
* update.py: check if source updates were successful
* update README.md variable mapping table from types.yml
* support ros services
* support ros actions

## Maybe
* CODESYS attributes equal to boolean value
* 'types_map' and 'types.yaml' to 'typesmap(.yml)'
* use std_msgs MultiArray instead of custom VarLen?
  * compare performance
  * what else?
* add cpp/ros_decl (type+name+arrlen)
* change Variable.parent to .parent_var
* change Variable \_\_eq\_\_ to compare 'self.name' as well
* encapsulate everything in class(es): RobinUpdateStarter, RobinUpdater
* detect shell used to compile
* start_update.py: config.yml for ssh settings
* ros side as service as well
* single shm space
* change header files to .hpp extension
* change inst.cpp to impl.cpp
* use c++ macros to automate struct member assignments based on structs.h
* group RobinPublishers with same rate into single threads
* pass DEF_ARRAY_SIZE to robin fb
* update.py: print 'Updating...' and pause inside


# Code

## robin_node.cpp
```c++
  // enable rosconsole logging
  if (ros::console::set_logger_level(ROSCONSOLE_DEFAULT_NAME, ros::console::levels::Debug))
  {
   ros::console::notifyLoggerLevelsChanged();
  }
```

## structs.h
```c++
// avoid structure padding; not standard
#pragma pack(1) -->
```

## start_update.py
```python
# scan network
gw = online.gateways['Gateway-1']
gw.perform_network_scan()
try:
    online.gateways['Gateway-1'].perform_network_scan()
except:
    system.ui.error('Update failed.')
    raise SystemExit
devices = projects.primary.find('Device', recursive=False)
if devices is None or len(devices) != 1:
    system.ui.error('Failed to find device.')
    raise SystemExit
guid = devices[0].get_gateway()
online.gateways[guid].perform_network_scan()
```

## update.py
```python
# add codesyscontrol restart command to sudoers.d
cmd = '''sudo -n systemctl restart codesyscontrol 2> /dev/null ||
         ls /etc/sudoers.d/allow_restart_codesyscontrol > /dev/null 2>&1 ||
         echo "$USER ALL=(ALL:ALL) NOPASSWD: $(which systemctl) restart codesyscontrol" |
         sudo EDITOR="tee" visudo -f /etc/sudoers.d/allow_restart_codesyscontrol > /dev/null &&
         sudo -n systemctl restart codesyscontrol'''
```

## robin.xml
```xml
<!-- codesys multidimensional arrays -->
<variable name="double_flarray_to_codesys_1">
  <type>
    <array>
      <dimension lower="1" upper="5" />
      <baseType>
        <derived name="TestStruct_foo" />
      </baseType>
    </array>
  </type>
  <documentation>
    <xhtml xmlns="http://www.w3.org/1999/xhtml">  struct_to_codesys_arr: TestStruct_arr;</xhtml>
  </documentation>
</variable>
<variable name="double_flarray_to_codesys_2">
  <type>
    <array>
      <dimension lower="1" upper="5" />
      <dimension lower="1" upper="10" />
      <baseType>
        <LREAL />
      </baseType>
    </array>
  </type>
</variable>
<variable name="double_flarray_to_codesys_3">
  <type>
    <array>
      <dimension lower="1" upper="5" />
      <baseType>
        <array>
          <dimension lower="1" upper="5" />
          <baseType>
            <LREAL />
          </baseType>
        </array>
      </baseType>
    </array>
  </type>
</variable>
```
